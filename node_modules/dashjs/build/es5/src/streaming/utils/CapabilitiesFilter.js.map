{"version":3,"sources":["../../../../../src/streaming/utils/CapabilitiesFilter.js"],"names":["CapabilitiesFilter","context","instance","adapter","capabilities","settings","logger","customCapabilitiesFilters","setup","getInstance","getLogger","setConfig","config","filterUnsupportedFeaturesOfPeriod","streamInfo","_filterUnsupportedCodecs","Constants","VIDEO","AUDIO","get","streaming","filterUnsupportedEssentialProperties","_filterUnsupportedEssentialProperties","_applyCustomFilters","type","realPeriod","getRealPeriodByIndex","index","AdaptationSet_asArray","length","filter","as","Representation_asArray","getIsTypeOf","_","i","codec","getCodec","supportsCodec","error","rep","essentialProperties","getEssentialPropertiesForRepresentation","supportsEssentialProperty","debug","schemeIdUri","representation","some","customFilter","setCustomCapabilitiesFilters","customFilters","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"CapabilitiesFilter.js","sourcesContent":["import FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport Constants from '../constants/Constants';\n\nfunction CapabilitiesFilter() {\n    const context = this.context;\n    let instance,\n        adapter,\n        capabilities,\n        settings,\n        logger,\n        customCapabilitiesFilters;\n\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function setConfig(config) {\n        if (!config) {\n            return;\n        }\n\n        if (config.adapter) {\n            adapter = config.adapter;\n        }\n\n        if (config.capabilities) {\n            capabilities = config.capabilities;\n        }\n\n        if (config.settings) {\n            settings = config.settings;\n        }\n\n    }\n\n    function filterUnsupportedFeaturesOfPeriod(streamInfo) {\n        _filterUnsupportedCodecs(Constants.VIDEO, streamInfo);\n        _filterUnsupportedCodecs(Constants.AUDIO, streamInfo);\n\n        if (settings.get().streaming.filterUnsupportedEssentialProperties) {\n            _filterUnsupportedEssentialProperties(streamInfo);\n        }\n\n        _applyCustomFilters(streamInfo);\n    }\n\n\n    function _filterUnsupportedCodecs(type, streamInfo) {\n        const realPeriod = adapter.getRealPeriodByIndex(streamInfo ? streamInfo.index : null);\n\n        if (!realPeriod || !realPeriod.AdaptationSet_asArray || realPeriod.AdaptationSet_asArray.length === 0) {\n            return;\n        }\n\n        realPeriod.AdaptationSet_asArray = realPeriod.AdaptationSet_asArray.filter((as) => {\n\n            if (!as.Representation_asArray || as.Representation_asArray.length === 0 || !adapter.getIsTypeOf(as, type)) {\n                return true;\n            }\n\n            as.Representation_asArray = as.Representation_asArray.filter((_, i) => {\n                const codec = adapter.getCodec(as, i, true);\n                if (!capabilities.supportsCodec(codec)) {\n                    logger.error('[Stream] codec not supported: ' + codec);\n                    return false;\n                }\n                return true;\n            });\n\n            return as.Representation_asArray && as.Representation_asArray.length > 0;\n        });\n\n    }\n\n    function _filterUnsupportedEssentialProperties(streamInfo) {\n        const realPeriod = adapter.getRealPeriodByIndex(streamInfo ? streamInfo.index : null);\n\n        if (!realPeriod || !realPeriod.AdaptationSet_asArray || realPeriod.AdaptationSet_asArray.length === 0) {\n            return;\n        }\n\n        realPeriod.AdaptationSet_asArray = realPeriod.AdaptationSet_asArray.filter((as) => {\n\n            if (!as.Representation_asArray || as.Representation_asArray.length === 0) {\n                return true;\n            }\n\n            as.Representation_asArray = as.Representation_asArray.filter((rep) => {\n                const essentialProperties = adapter.getEssentialPropertiesForRepresentation(rep);\n\n                if (essentialProperties && essentialProperties.length > 0) {\n                    let i = 0;\n                    while (i < essentialProperties.length) {\n                        if (!capabilities.supportsEssentialProperty(essentialProperties[i])) {\n                            logger.debug('[Stream] EssentialProperty not supported: ' + essentialProperties[i].schemeIdUri);\n                            return false;\n                        }\n                        i += 1;\n                    }\n                }\n\n                return true;\n            });\n\n            return as.Representation_asArray && as.Representation_asArray.length > 0;\n        });\n\n    }\n\n    function _applyCustomFilters(streamInfo) {\n        if (!customCapabilitiesFilters || customCapabilitiesFilters.length === 0) return;\n\n        const realPeriod = adapter.getRealPeriodByIndex(streamInfo ? streamInfo.index : null);\n\n        if (!realPeriod || !realPeriod.AdaptationSet_asArray || realPeriod.AdaptationSet_asArray.length === 0) {\n            return;\n        }\n\n        realPeriod.AdaptationSet_asArray = realPeriod.AdaptationSet_asArray.filter((as) => {\n\n            if (!as.Representation_asArray || as.Representation_asArray.length === 0) {\n                return true;\n            }\n\n            as.Representation_asArray = as.Representation_asArray.filter((representation) => {\n                return !customCapabilitiesFilters.some(customFilter => !customFilter(representation));\n            });\n\n            return as.Representation_asArray && as.Representation_asArray.length > 0;\n        });\n    }\n\n    function setCustomCapabilitiesFilters(customFilters) {\n        customCapabilitiesFilters = customFilters;\n    }\n\n    instance = {\n        setConfig,\n        filterUnsupportedFeaturesOfPeriod,\n        setCustomCapabilitiesFilters\n    };\n\n    setup();\n\n    return instance;\n}\n\nCapabilitiesFilter.__dashjs_factory_name = 'CapabilitiesFilter';\nexport default FactoryMaker.getSingletonFactory(CapabilitiesFilter);\n"]}
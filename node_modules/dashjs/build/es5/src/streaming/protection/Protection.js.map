{"version":3,"sources":["../../../../../src/streaming/protection/Protection.js"],"names":["APIS_ProtectionModel_01b","generateKeyRequest","addKey","cancelKeyRequest","needkey","keyerror","keyadded","keymessage","APIS_ProtectionModel_3Feb2014","setMediaKeys","MediaKeys","release","error","message","ready","close","Protection","instance","context","createProtectionSystem","config","controller","protectionKeyController","getInstance","setConfig","debug","BASE64","initialize","protectionModel","getProtectionModel","create","eventBus","events","constants","cmcdModel","settings","capabilities","setEncryptedMediaSupported","logger","getLogger","errHandler","videoElement","videoModel","getElement","onencrypted","undefined","mediaKeys","info","getAPI","api","warn","apis","i","length","Object","keys","__dashjs_factory_name","factory","dashjs","FactoryMaker","getClassFactory","ProtectionEvents","errors","ProtectionErrors","updateClassFactory"],"mappings":"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","file":"Protection.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport ProtectionController from './controllers/ProtectionController';\nimport ProtectionKeyController from './controllers/ProtectionKeyController';\nimport ProtectionEvents from './ProtectionEvents';\nimport ProtectionErrors from './errors/ProtectionErrors';\nimport ProtectionModel_21Jan2015 from './models/ProtectionModel_21Jan2015';\nimport ProtectionModel_3Feb2014 from './models/ProtectionModel_3Feb2014';\nimport ProtectionModel_01b from './models/ProtectionModel_01b';\n\nconst APIS_ProtectionModel_01b = [\n    // Un-prefixed as per spec\n    {\n        // Video Element\n        generateKeyRequest: 'generateKeyRequest',\n        addKey: 'addKey',\n        cancelKeyRequest: 'cancelKeyRequest',\n\n        // Events\n        needkey: 'needkey',\n        keyerror: 'keyerror',\n        keyadded: 'keyadded',\n        keymessage: 'keymessage'\n    },\n    // Webkit-prefixed (early Chrome versions and Chrome with EME disabled in chrome://flags)\n    {\n        // Video Element\n        generateKeyRequest: 'webkitGenerateKeyRequest',\n        addKey: 'webkitAddKey',\n        cancelKeyRequest: 'webkitCancelKeyRequest',\n\n        // Events\n        needkey: 'webkitneedkey',\n        keyerror: 'webkitkeyerror',\n        keyadded: 'webkitkeyadded',\n        keymessage: 'webkitkeymessage'\n    }\n];\n\nconst APIS_ProtectionModel_3Feb2014 = [\n    // Un-prefixed as per spec\n    // Chrome 38-39 (and some earlier versions) with chrome://flags -- Enable Encrypted Media Extensions\n    {\n        // Video Element\n        setMediaKeys: 'setMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MediaKeys',\n        // MediaKeySession\n        release: 'close',\n\n        // Events\n        needkey: 'needkey',\n        error: 'keyerror',\n        message: 'keymessage',\n        ready: 'keyadded',\n        close: 'keyclose'\n    },\n    // MS-prefixed (IE11, Windows 8.1)\n    {\n        // Video Element\n        setMediaKeys: 'msSetMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MSMediaKeys',\n        // MediaKeySession\n        release: 'close',\n        // Events\n        needkey: 'msneedkey',\n        error: 'mskeyerror',\n        message: 'mskeymessage',\n        ready: 'mskeyadded',\n        close: 'mskeyclose'\n    }\n];\n\nfunction Protection() {\n    let instance;\n    const context = this.context;\n\n    /**\n     * Create a ProtectionController and associated ProtectionModel for use with\n     * a single piece of content.\n     *\n     * @param {Object} config\n     * @return {ProtectionController} protection controller\n     *\n     */\n    function createProtectionSystem(config) {\n        let controller = null;\n\n        const protectionKeyController = ProtectionKeyController(context).getInstance();\n        protectionKeyController.setConfig({ debug: config.debug, BASE64: config.BASE64 });\n        protectionKeyController.initialize();\n\n        let protectionModel =  getProtectionModel(config);\n\n        if (!controller && protectionModel) {//TODO add ability to set external controller if still needed at all?\n            controller = ProtectionController(context).create({\n                protectionModel: protectionModel,\n                protectionKeyController: protectionKeyController,\n                eventBus: config.eventBus,\n                debug: config.debug,\n                events: config.events,\n                BASE64: config.BASE64,\n                constants: config.constants,\n                cmcdModel: config.cmcdModel,\n                settings: config.settings\n            });\n            config.capabilities.setEncryptedMediaSupported(true);\n        }\n        return controller;\n    }\n\n    function getProtectionModel(config) {\n        const debug = config.debug;\n        const logger = debug.getLogger(instance);\n        const eventBus = config.eventBus;\n        const errHandler = config.errHandler;\n        const videoElement = config.videoModel ? config.videoModel.getElement() : null;\n\n        if ((!videoElement || videoElement.onencrypted !== undefined) &&\n            (!videoElement || videoElement.mediaKeys !== undefined)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_21Jan2015)');\n            return ProtectionModel_21Jan2015(context).create({ debug: debug, eventBus: eventBus, events: config.events });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_3Feb2014)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_3Feb2014)');\n            return ProtectionModel_3Feb2014(context).create({ debug: debug, eventBus: eventBus, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_3Feb2014) });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_01b)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_01b)');\n            return ProtectionModel_01b(context).create({ debug: debug, eventBus: eventBus, errHandler: errHandler, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_01b) });\n        } else {\n            logger.warn('No supported version of EME detected on this user agent! - Attempts to play encrypted content will fail!');\n            return null;\n        }\n    }\n\n    function getAPI(videoElement, apis) {\n        for (let i = 0; i < apis.length; i++) {\n            const api = apis[i];\n            // detect if api is supported by browser\n            // check only first function in api -> should be fine\n            if (typeof videoElement[api[Object.keys(api)[0]]] !== 'function') {\n                continue;\n            }\n\n            return api;\n        }\n\n        return null;\n    }\n\n    instance = {\n        createProtectionSystem: createProtectionSystem\n    };\n\n    return instance;\n}\n\nProtection.__dashjs_factory_name = 'Protection';\nconst factory = dashjs.FactoryMaker.getClassFactory(Protection); /* jshint ignore:line */\nfactory.events = ProtectionEvents;\nfactory.errors = ProtectionErrors;\ndashjs.FactoryMaker.updateClassFactory(Protection.__dashjs_factory_name, factory); /* jshint ignore:line */\nexport default factory;\n"]}